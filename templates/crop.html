{% extends "base.html"%}

{% block title %}Crop Recommendation{% endblock %}
    {% block head %}
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --forest: #1a2f23;
            --sprout: #a8e063;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: #0f1b14;
            color: #f0f4f2;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding-top: 80px;
        }

        .main-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .form-label { color: var(--sprout); font-size: 0.85rem; text-transform: uppercase; font-weight: 600; }
        .form-control { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); color: white; border-radius: 12px; }
        .form-control:focus { background: rgba(255, 255, 255, 0.07); border-color: var(--sprout); color: white; box-shadow: 0 0 15px rgba(168, 224, 99, 0.2); }

        .predict-btn {
            background: var(--sprout); color: var(--forest); border: none; font-weight: 700;
            padding: 15px 50px; border-radius: 50px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
        }
        .predict-btn:hover { transform: scale(1.05); background: #96d152; }

        #map { height: 350px; width: 100%; border-radius: 12px; border: 1px solid #a8e063; margin-top: 10px; }
        .search-box { position: relative; margin-bottom: 15px; }
        #addressInput { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #fff; color: #333; }
        #results { position: absolute; width: 100%; background: white; color: #222; z-index: 2000; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; }
        .result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

        .weather-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .w-item { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(168, 224, 99, 0.1); }
        .w-item span { display: block; font-size: 1.2rem; font-weight: bold; color: #a8e063; }

        .result-card { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); color: var(--forest); border-radius: 20px; padding: 25px; margin-top: 30px; }
    </style>
        {% endblock %}
{% block content %} 
<div class="container">
    <div class="main-container">
        <div class="text-center mb-5">
            <h1 class="display-5">Crop Recommendation</h1>
            <p style="opacity: 0.7;">Fill in the soil details and select your location on the map.</p>
        </div>

        <form action="/predict" method="POST">
            <input type="hidden" id="hidden_temp" name="Temperature">
            <input type="hidden" id="hidden_humidity" name="Humidity">
            <input type="hidden" id="hidden_rainfall" name="Rainfall">

            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label">Nitrogen (N)</label>
                    <input type="number" name="Nitrogen" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Phosphorus (P)</label>
                    <input type="number" name="Phosporus" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Potassium (K)</label>
                    <input type="number" name="Potassium" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">pH Level</label>
                    <input type="number" step="0.01" name="Ph" class="form-control" required>
                </div>

                <div class="col-md-12">
                    <hr style="border-color: rgba(168, 224, 99, 0.2);">
                    <h3 style="font-size: 1.2rem; color: var(--sprout);"><i class="fas fa-map-marker-alt"></i> Field Location & Weather</h3>
                    <div class="search-box">
                        <input type="text" id="addressInput" placeholder="Search village or city...">
                        <div id="results"></div>
                    </div>
                    <div id="map"></div>

                    <div class="weather-grid">
                        <div class="w-item">Avg Temp<span id="display_temp">--°C</span></div>
                        <div class="w-item">Total Rain<span id="display_rain">-- mm</span></div>
                        <div class="w-item">Avg Humidity<span id="display_humidity">-- %</span></div>
                    </div>
                </div>

                <div class="col-md-12 text-center mt-5">
                    <button type="submit" class="predict-btn">Get Recommendation</button>
                </div>
            </div>
        </form>

        {% if results %}
        <div class="mt-5" id="prediction-results">
            <h3 class="text-center mb-4" style="color: var(--sprout);">Top Recommended Crops</h3>
            <div class="row g-4 justify-content-center">
                {% for item in results %}
                <div class="col-md-4">
                    <div class="result-card shadow">
                        <small class="text-uppercase fw-bold">Option #{{ loop.index }}</small>
                        <h2 class="fw-bold my-2">{{ item.name }}</h2>
                        <p class="m-0">Confidence: <b>{{ item.confidence }}%</b></p>
                        <div class="progress mt-2" style="height: 8px; background: rgba(0,0,0,0.1);">
                            <div class="progress-bar bg-dark" style="width: {{ item.confidence }} %"></div>
                        </div>
                    </div>  
                </div>
                {% endfor %}
            </div>
        </div>
        <script>document.getElementById('prediction-results').scrollIntoView({behavior: 'smooth'});</script>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([19.0760, 72.8777], 10);
    L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    var marker = L.marker([19.0760, 72.8777], {draggable: true}).addTo(map);

   async function getLastYearTrend(lat, lon) {

   const today = new Date();
        const start = new Date();
        start.setFullYear(today.getFullYear() - 1);
        const end = new Date();
        end.setFullYear(today.getFullYear() - 1);
        end.setMonth(start.getMonth() + 2);

        const sStr = start.toISOString().split('T')[0];
        const eStr = end.toISOString().split('T')[0];
    const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${sStr}&end_date=${eStr}&daily=precipitation_sum,temperature_2m_max,relative_humidity_2m_mean&timezone=auto`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        console.log("Fetched Weather Data:", data);
        
        const totalR = (data.daily.precipitation_sum.reduce((a,b) => a + b, 0)/data.daily.precipitation_sum.length).toFixed(1);
        const avgT = (data.daily.temperature_2m_max.reduce((a,b) => a + b, 0) / data.daily.temperature_2m_max.length).toFixed(1);
        const avgH = (data.daily.relative_humidity_2m_mean.reduce((a,b) => a + b, 0) / data.daily.relative_humidity_2m_mean.length).toFixed(1);

  
        document.getElementById("display_rain").innerText = totalR + " mm";
        document.getElementById("display_temp").innerText = avgT + "°C";
        document.getElementById("display_humidity").innerText = avgH + " %";


        document.getElementById("hidden_rainfall").value = totalR; 
        document.getElementById("hidden_temp").value = avgT;
        document.getElementById("hidden_humidity").value = avgH;

    } catch (e) { 
        console.error("Rainfall data fetch error", e); 
    }
}

    marker.on('dragend', function() {
        let p = marker.getLatLng();
        getLastYearTrend(p.lat, p.lng);
    });

    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        getLastYearTrend(e.latlng.lat, e.latlng.lng);
    });

    // Search Logic
    const addrInput = document.getElementById('addressInput');
    const resDiv = document.getElementById('results');

    addrInput.addEventListener('input', function() {
        let q = addrInput.value;
        console.log("Searching for:", q);
        if(q.length < 3) { resDiv.innerHTML = ''; return; }
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=in&limit=5`)
        .then(r => r.json()).then(data => {
            resDiv.innerHTML = '';
            data.forEach(item => {
                let d = document.createElement('div');
                d.className = 'result-item';
                d.innerText = item.display_name;
                d.onclick = () => {
                    map.setView([item.lat, item.lon], 12);
                    marker.setLatLng([item.lat, item.lon]);
                    getLastYearTrend(item.lat, item.lon);
                    addrInput.value = item.display_name;
                    resDiv.innerHTML = '';
                };
                resDiv.appendChild(d);
            });
        });
    });
</script>
{% endblock %}
